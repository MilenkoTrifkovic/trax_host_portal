rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userRole() {
      return userDoc().data.role;
    }

    function userOrgId() {
      return userDoc().data.organisationId;
    }

    function isSuperAdmin() {
      return isSignedIn() && userRole() == "superAdmin";
    }

    // helper to fetch event's organisation id
    function eventOrgId(eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data.organisationId;
    }

    // Organisations - keep read only to signed in users
    match /organisations/{orgDocId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // Menus collection (dev mode)
    match /menus/{menuId} {
      allow read, write: if isSignedIn();
    }

    // Menu items collection (dev mode)
    match /menu_items/{menuItemId} {
      allow read, create, update, delete: if isSignedIn();
    }

    // Users (TEMP)
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if false;
    }

    // Events (TEMP - dev)
    match /events/{eventId} {
      allow read: if true;          // ✅ guest needs to read
      allow create, update, delete: if isSignedIn();
    }
    // Responses subcollection
    match /events/{eventId}/responses/{respId} {
      allow create: if isSignedIn() && (isSuperAdmin() || userOrgId() == eventOrgId(eventId));
      allow read: if isSignedIn() && (isSuperAdmin() || userOrgId() == eventOrgId(eventId));
      allow update, delete: if false;
    }

    // guestResponses (existing)
   	match /events/{eventId}/guestResponses/{docId} {
      allow read, write: if true;  // dev only
    }

    // guestQuestions config
    match /events/{eventId}/guestQuestions/{docId} {
      allow read, write: if isSignedIn();
    }

		match /demographicQuestionSets/{setId} {
      allow get: if
        !exists(/databases/$(database)/documents/demographicQuestionSets/$(setId)) ||
        get(/databases/$(database)/documents/demographicQuestionSets/$(setId)).data.isDisabled != true;

      allow list: if isSignedIn();
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    match /demographicQuestions/{questionId} {
      allow read: if
        !exists(/databases/$(database)/documents/demographicQuestions/$(questionId)) ||
        get(/databases/$(database)/documents/demographicQuestions/$(questionId)).data.isDisabled != true;

      allow write: if isSignedIn();
    }

    match /demographicQuestionOptions/{optId} {
      allow read: if
        !exists(/databases/$(database)/documents/demographicQuestionOptions/$(optId)) ||
        get(/databases/$(database)/documents/demographicQuestionOptions/$(optId)).data.isDisabled != true;

      allow write: if isSignedIn();
    }


    // Venues dev
    match /venues/{venueId} {
      allow read, create, update, delete: if isSignedIn();
    }

    // Guests dev (org-level)
   match /guests/{guestId} {
      allow read: if true;
      allow create: if true;     // ✅ allow guest to create companion docs
      allow update, delete: if false; // keep tight
    }

    match /invitations/{invId} {
      allow get: if true;
      allow list: if false;

      allow create: if isSignedIn();
      allow delete: if false;

      allow update: if
        request.resource.data.token == resource.data.token &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly([
          // RSVP
          'isAttending', 'rsvpSubmittedAt', 'declineReason',

          // Companions step
          'companions',
          'companionsCount', 'companionsSubmittedAt', 'isInvitingCompanionsByEmail',
          'savedCompanionsCount',              // ✅ ADD
          'remainingCompanionsToCreate',       // ✅ ADD

          // Demographics completion
          'used', 'demographicsSubmittedAt',

          // Menu completion
          'menuSelectionSubmitted', 'menuSubmittedAt',

          // optional
          'updatedAt'
        ]);
    }



    // Demographic Responses: Anyone can create (guest submission), only org members can read
    match /demographicQuestionsResponses/{respId} {
      allow create: if true;
      allow read: if isSignedIn();
      allow update, delete: if false;
    }


    // Invitation Logs: Only org members can read
    match /invitationLogs/{logId} {
      allow read: if isSignedIn() && (
        isSuperAdmin() ||
        userOrgId() == resource.data.organisationId
      );
      allow write: if false;
    }
  }
}
